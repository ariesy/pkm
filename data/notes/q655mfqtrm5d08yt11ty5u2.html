<h1 id="forward-wsl-port-to-host">Forward Wsl Port to Host<a aria-hidden="true" class="anchor-heading icon-link" href="#forward-wsl-port-to-host"></a></h1>
<p>If you start a service in WSL that expose some port (like you are running a website with docker in WSL), it can only be accessed from your own machine with the WSL ip address. What if you want to allow other people access it from another machine? You can run the following powershell scripts to forward ports out.</p>
<pre class="language-powershell"><code class="language-powershell">
<span class="token keyword">If</span> <span class="token punctuation">(</span><span class="token operator">-NOT</span> <span class="token punctuation">(</span><span class="token namespace">[Security.Principal.WindowsPrincipal]</span><span class="token namespace">[Security.Principal.WindowsIdentity]</span>::GetCurrent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>IsInRole<span class="token punctuation">(</span><span class="token namespace">[Security.Principal.WindowsBuiltInRole]</span> <span class="token string">"Administrator"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
  <span class="token variable">$arguments</span> = <span class="token string">"&#x26; '"</span> <span class="token operator">+</span> <span class="token variable">$myinvocation</span><span class="token punctuation">.</span>mycommand<span class="token punctuation">.</span>definition <span class="token operator">+</span> <span class="token string">"'"</span>
  <span class="token function">Start-Process</span> powershell <span class="token operator">-</span>Verb runAs <span class="token operator">-</span>ArgumentList <span class="token variable">$arguments</span>
  <span class="token keyword">Break</span>
<span class="token punctuation">}</span>

<span class="token variable">$remoteport</span> = bash<span class="token punctuation">.</span>exe <span class="token operator">-</span>c <span class="token string">"ifconfig eth0 | grep 'inet '"</span>
<span class="token variable">$found</span> = <span class="token variable">$remoteport</span> <span class="token operator">-match</span> <span class="token string">'\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$found</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token variable">$remoteport</span> = <span class="token variable">$matches</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>
  <span class="token function">echo</span> <span class="token string">"The Script Exited, the ip address of WSL 2 cannot be found"</span><span class="token punctuation">;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">#[Ports]</span>

<span class="token comment">#All the ports you want to forward separated by coma</span>
<span class="token variable">$ports</span>=@<span class="token punctuation">(</span>10000<span class="token punctuation">,</span>3000<span class="token punctuation">,</span>5000<span class="token punctuation">,</span>8088<span class="token punctuation">,</span>5432<span class="token punctuation">,</span>5433<span class="token punctuation">,</span>8000<span class="token punctuation">,</span>8443<span class="token punctuation">,</span>8083<span class="token punctuation">,</span>9002<span class="token punctuation">,</span>9092<span class="token punctuation">,</span>8081<span class="token punctuation">,</span>5601<span class="token punctuation">,</span>3030<span class="token punctuation">,</span>3080<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">#[Static ip]</span>
<span class="token comment">#You can change the addr to your ip config to listen to a specific address</span>
<span class="token variable">$addr</span>=<span class="token string">'0.0.0.0'</span><span class="token punctuation">;</span>
<span class="token variable">$ports_a</span> = <span class="token variable">$ports</span> <span class="token operator">-join</span> <span class="token string">","</span><span class="token punctuation">;</span>


<span class="token comment">#Remove Firewall Exception Rules</span>
<span class="token function">iex</span> <span class="token string">"Remove-NetFireWallRule -DisplayName 'WSL 2 Firewall Unlock' "</span><span class="token punctuation">;</span>

<span class="token comment">#adding Exception Rules for inbound and outbound Rules</span>
<span class="token function">iex</span> <span class="token string">"New-NetFireWallRule -DisplayName 'WSL 2 Firewall Unlock' -Direction Outbound -LocalPort <span class="token variable">$ports_a</span> -Action Allow -Protocol TCP"</span><span class="token punctuation">;</span>
<span class="token function">iex</span> <span class="token string">"New-NetFireWallRule -DisplayName 'WSL 2 Firewall Unlock' -Direction Inbound -LocalPort <span class="token variable">$ports_a</span> -Action Allow -Protocol TCP"</span><span class="token punctuation">;</span>

<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token variable">$i</span> = 0<span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">-lt</span> <span class="token variable">$ports</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token variable">$port</span> = <span class="token variable">$ports</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">iex</span> <span class="token string">"netsh interface portproxy delete v4tov4 listenport=<span class="token variable">$port</span> listenaddress=<span class="token variable">$addr</span>"</span><span class="token punctuation">;</span>
  <span class="token function">iex</span> <span class="token string">"netsh interface portproxy add v4tov4 listenport=<span class="token variable">$port</span> listenaddress=<span class="token variable">$addr</span> connectport=<span class="token variable">$port</span> connectaddress=<span class="token variable">$remoteport</span>"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">iex</span> <span class="token string">"netsh interface portproxy show v4tov4"</span><span class="token punctuation">;</span>
</code></pre>
<p>⚠️ This need to be done every time WSL is restarted.</p>
<p><a href="/assets/scripts/forward_wsl.ps1">forward_wsl.ps1</a></p>
<hr>
<h2 id="tags">Tags<a aria-hidden="true" class="anchor-heading icon-link" href="#tags"></a></h2>
<ol>
<li><a class="color-tag" style="--tag-color: #befd73;" href="/notes/e0xa4qkdstbefku97z2p56o">#WSL</a></li>
<li><a class="color-tag" style="--tag-color: #87fd05;" href="/notes/u0li8mukqqst0xdm21v9cjn">#powershell</a></li>
</ol>